{# templates/inventario/_producto_row.html #}
{% load tz %}
<tr
  data-sku="{{ producto.sku }}"
  {% if producto.proximo_vencimiento and producto.proximo_vencimiento < today %} class="vencido"
  {% elif producto.proximo_vencimiento and producto.proximo_vencimiento|date:"U" <= hoy_mas_15dias %} class="proximo-vencer"
  {% elif producto.stock_total and producto.stock_total <= 5 %} class="stock-bajo"
  {% endif %}>

  <td>{{ producto.nombre }}</td>
  <td>{{ producto.sku }}</td>
  <td>{{ producto.marca|default:"N/A" }}</td>
  <td>{{ producto.get_categoria_display }}</td>
  <td>{{ producto.stock_total|default:"0" }}</td>
  <td>{{ producto.cantidad_lotes|default:"0" }}</td>

  <td class="acciones">
    {% with has_lotes=producto.cantidad_lotes %}
      {% if producto.sell_by_weight %}
        {% if has_lotes %}
          <a href="{% url 'salida_cecina_monto' %}?sku={{ producto.sku }}"
             class="btn icon-btn icon-btn--cash"
             title="Descontar por monto ($â†’g)" aria-label="Descontar por monto">
            <i class="bi bi-cash-coin" aria-hidden="true"></i>
          </a>
        {% else %}
          <a href="#"
             class="btn icon-btn icon-btn--cash is-disabled"
             aria-disabled="true" tabindex="-1"
             title="Sin lotes registrados">
            <i class="bi bi-cash-coin" aria-hidden="true"></i>
          </a>
        {% endif %}
      {% else %}
        <form method="post" action="{% url 'ajustar_stock' producto.id %}" style="display:inline;">
          {% csrf_token %}
          <input type="hidden" name="operacion" value="sumar">
          <input type="hidden" name="cantidad" value="1">
          <button type="submit"
                  class="btn icon-btn"
                  {% if not has_lotes %}disabled aria-disabled="true" title="Sin lotes registrados"{% else %}title="Sumar 1"{% endif %}
                  aria-label="Sumar 1">
            <i class="bi bi-plus-lg" aria-hidden="true"></i>
          </button>
        </form>

        <form method="post" action="{% url 'ajustar_stock' producto.id %}" style="display:inline;">
          {% csrf_token %}
          <input type="hidden" name="operacion" value="restar">
          <input type="hidden" name="cantidad" value="1">
          <button type="submit"
                  class="btn icon-btn"
                  {% if not has_lotes %}disabled aria-disabled="true" title="Sin lotes registrados"{% else %}title="Restar 1"{% endif %}
                  aria-label="Restar 1">
            <i class="bi bi-dash-lg" aria-hidden="true"></i>
          </button>
        </form>
      {% endif %}

      <a href="{% url 'eliminar_producto' producto.id %}"
         class="btn icon-btn icon-btn--danger"
         title="Eliminar producto" aria-label="Eliminar producto">
        <i class="bi bi-trash3" aria-hidden="true"></i>
      </a>

      <a href="{% url 'flujo_opciones' producto.id %}"
         class="btn icon-btn icon-btn--primary"
         title="Gestionar lotes y proveedores" aria-label="Gestionar lotes y proveedores">
        <i class="bi bi-gear-wide-connected" aria-hidden="true"></i>
      </a>
    {% endwith %}
  </td>
</tr>